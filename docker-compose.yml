version: "3.9"

services:
  redis:
    container_name: redis
    image: redis
    restart: always
    ports:
    - "6379:6379"
    command:  redis-server --save 60 1 --loglevel warning
  backend:
    build: .
    container_name: Cbv
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./:/app
    ports:
      - "8000:8000"
    environment:
      # SECRET_KEY: django-insecure-rh)10532-c8@@tz)gu$1*f*ff%1%3(&xvs#h8xqy$neo2q)4n0
      # DEBUG: "True"
      - SECRET_KEY=test
      - DEBUG=True
    depends_on:
      - redis  

  redis-worker:
    build: .
    command: celery -A core worker --loglevel=info
    volumes:
      - ./:/app
    depends_on:
      - redis
      - backend


  master:
    image: locustio/locust
    ports:
     - "8089:8089"
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --master -H http://backend:8000
  
  locust-worker:
    image: locustio/locust
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --worker --master-host master


  smtp4dev:
      image: rnwood/smtp4dev:v3
      restart: always
      ports:
        # Change the number before : to the port the web interface should be accessible on
        - '5000:80'
        # Change the number before : to the port the SMTP server should be accessible on
        - '25:25'
        # Change the number before : to the port the IMAP server should be accessible on
        - '143:143'
      volumes:
        # This is where smtp4dev stores the database..
          - smtp4dev-data:/smtp4dev
      environment:
        # Uncomment to customise these settings
        # This is not a complete list of the available settings.
        # See the documentation in appsettings.json for a full list.

        #Specifies the virtual path from web server root where SMTP4DEV web interface will be hosted. e.g. "/" or "/smtp4dev"
        #- ServerOptions__BasePath=/smtp4dev

        #Specifies the URLs the web UI will use inside the container.
       #- ServerOptions__Urls=http://*:80

        #Specifies the server hostname. Used in auto-generated TLS certificate if enabled.
        - ServerOptions__HostName=smtp4dev

        #Locks settings from being changed by user via web interface
        #- ServerOptions__LockSettings=true

        #Specifies the path where the database will be stored relative to APPDATA env var on Windows or XDG_CONFIG_HOME on non-Windows. Specify "" to use an in memory database.
        #- ServerOptions__Database=database.db

        #Specifies the number of messages to keep
        #- ServerOptions__NumberOfMessagesToKeep=100

        #Specifies the number of sessions to keep
        #- ServerOptions__NumberOfSessionsToKeep=100

        #Specifies the TLS mode to use. None=Off. StartTls=On demand if client supports STARTTLS. ImplicitTls=TLS as soon as connection is established.
        #- ServerOptions__TlsMode=None

        #Specifies the TLS certificate to use if TLS is enabled/requested. Specify "" to use an auto-generated self-signed certificate (then see console output on first startup)
        #- ServerOptions__TlsCertificate=

        #Sets the name of the SMTP server that will be used to relay messages or "" if messages should not be relayed
        #- RelayOptions__SmtpServer=

        #Sets the port number for the SMTP server used to relay messages.
        #- RelayOptions__SmtpPort=25

        #Specifies a comma separated list of recipient addresses for which messages will be relayed. An empty list means that no messages are relayed.
        #- RelayOptions__AllowedEmailsString=

        #Specifies the address used in MAIL FROM when relaying messages. (Sender address in message headers is left unmodified). The sender of each message is used if not specified.
        #- RelayOptions__SenderAddress=

        #The username for the SMTP server used to relay messages. If "" no authentication is attempted.
        #- RelayOptions__Login=

        #The password for the SMTP server used to relay messages
        #- RelayOptions__Password=

        #Specifies the port the IMAP server will listen on - allows standard email clients to view/retrieve messages
        #"ServerOptions__ImapPort"=143
volumes:
        smtp4dev-data:


